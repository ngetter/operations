{% extends "base.html" %}
{% block script %}
<script>

    $.fn.editable.defaults.mode = 'popup';
    $(document).ready(function() {
        $('.editable').editable({
            type: 'text',
            //name: 'operations/instructor',
            url: '/update',
            title: 'בחר שם אחר'
        });
    }); 
    
	$('.btn-arrival').click(function(){
		var btn = $(this)
		btn.button('loading').append('<span style="margin-right:0.5em" class="fa fa-circle-o-notch fa-spin pull-left"></span>');
        
		$.ajax({
			method: 'POST',
			url: 'mark_arrival',
            dataType: 'json',
			data: {id: btn.data('id'), username:'{{user.username}}'}
			})
			.done(function(str){
                $('#length_' +  btn.data('id')).html(str.length);
                btn.button('reset')
                if(str.participate==true) {
                    btn.html('<span class="glyphicon glyphicon-thumbs-up"></span>&nbsp;משתתף');
                    btn.removeClass('btn-primary').addClass('btn-success');
                    $('#' + btn.data('id')).removeClass('warning').addClass('success')
                    }
                else {
                    btn.html('<span class="glyphicon glyphicon-thumbs-down"></span>&nbsp;לא משתתף');
                    btn.removeClass('btn-success').addClass('btn-primary');
                    $('#' + btn.data('id')).removeClass('success').addClass('warning')
                    }
				});

	});

	$('.txt-message').click(function(){
		var btn = $(this)

		$.ajax({
			method: 'POST',
			url: 'add_message',
            dataType: 'json',
			data: {id: btn.data('id'), username:'{{user.username}}'}
			})
	});
    
    $('.modal-list').click(function(){
            $(".modal-content").html("<span>טוען...<span>")
            $.ajax({
                method: 'GET',
                url: $(this).attr('href')
            
            }).done(function(str){$(".modal-content").html(str)});
    });
    
    //$('.addthisevent').popover()



    
</script>
{% endblock %}

{% block page_style %}
<link rel="stylesheet"  href="{{ url_for('static', filename='css/ios6toggle.css') }}">
{% endblock %}

{% block content %}
<div id="modal" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">משתתפים בפעולה</h4>
        </div>
      טוען
    </div>
  </div>
</div>

<div class="page-header">
<h4>פעולות סוף השבוע הקרוב<!--&nbsp;<small>לפעולות קודמות&nbsp;<a href="">לחץ כאן</a></small>--></h4>
</div>

<table id="operations" class='table table-striped table-condensed' >
    {% for k in l[0:2] %}
    {% if k.participate %}
        {% if user.username not in k.participate  %}
            {% set buttonStatus = {'buttonClass':'btn-primary','buttonCaption':'לא משתתף', 'rowClass':'warning', 'glyph':'glyphicon-thumbs-down'} %}
            {% set btnMesage = {'buttonClass':'hidden'} %}
        {% else %}
            {% set buttonStatus = {'buttonClass':'btn-success','buttonCaption':'משתתף', 'rowClass':'success', 'glyph':'glyphicon-thumbs-up'} %}
            {% set btnMesage = {'buttonClass':''} %}
        {% endif %}
    {% else %}
        {% set buttonStatus = {'buttonClass':'btn-primary','buttonCaption':'לא משתתף', 'rowClass':'warning', 'glyph':'glyphicon-thumbs-down'} %}
        {% set btnMesage = {'buttonClass':'hidden'} %}
    {% endif %}
    
    <tr class='{{ buttonStatus.rowClass }}' id='{{ k._id }}'>
        <td ><span class="pull-right"><strong>{{ k['date'].strftime('%d.%m') }}</strong><br>{{ k['comment'] }}</span>
        {% if user.position %}
        <span  style="font-size:1.2em;margin-right:0.3em;" class="label label-success pull-right">{{ k['first'] | mytor(user['position'] | int )}}</span>
        {% else %}
        <a  href="#" style="font-size:1.2em;margin-right:0.3em;" class="label label-success pull-right editable" data-pk="{{user._id}}" data-name="users/position">{{ user['position'] | emptysign }}</a>
        {% endif %}
        
        </td>

        <td class="hidden-xs">
            <a class="editable" href="#" 
                data-pk="{{k._id}}"
                data-name="operations/instractor">{{ k['instractor'] | emptysign }}</a><br/>
            <a class="editable" href="#" 
                data-pk="{{k._id}}" 
                data-name="operations/incharge">{{ k['incharge'] | emptysign }}</a>
            
<!--             <a class="editable" href="#" 
                data-pk="{{k._id}}" 
                data-name="operations/first">{{ k['first'] }}</a> -->
        </td>        
        <td><!-- <a href="#" class="txt-comment" id="comment" data-type="text" data-pk="1" data-url="/post" data-title="Enter username">הערה</a> -->
            <button type="button" style="width:8em;" class="btn {{ buttonStatus.buttonClass }} btn-arrival btn-sm" data-id="{{ k._id  }}">
                <span class="glyphicon {{ buttonStatus.glyph }}"></span>&nbsp;{{ buttonStatus.buttonCaption }}
            </button>
        </td>
        <td>
            <button type="button" class="btn btn-link modal-list pull-left" id="modal_a_{{ k._id }}" data-toggle="modal" data-target="#modal" href="participants/{{ k._id }}">
                <span id='length_{{ k._id  }}' class="badge badge-primary">{{ k['participate']|length }}</span>
                <i class="fa fa-chevron-left"></i>        
            </a>
        </td>

    </tr>
    {% endfor %}
</table>

<div class="page-header">
<h4>פעולות נוספות</h4>
</div>
<table class='table table-striped table-condensed' >
    {% for k in l[2:] %}
    {% if k.participate %}
        {% if user.username not in k.participate  %}
            {% set buttonStatus = {'buttonClass':'btn-primary','buttonCaption':'לא משתתף', 'rowClass':'warning', 'glyph':'glyphicon-thumbs-down'} %}
        {% else %}
            {% set buttonStatus = {'buttonClass':'btn-success','buttonCaption':'משתתף', 'rowClass':'success', 'glyph':'glyphicon-thumbs-up'} %}
        {% endif %}
    {% else %}
        {% set buttonStatus = {'buttonClass':'btn-primary','buttonCaption':'לא משתתף', 'rowClass':'warning', 'glyph':'glyphicon-thumbs-down'} %}
    {% endif %}
    
    <tr class='{{ buttonStatus.rowClass }}' id='{{ k._id }}'>
        <td ><span class="pull-right"><strong>{{ k['date'].strftime('%d.%m') }}</strong><br>{{ k['comment'] }}</span>
        {% if user.position %}
        <span  style="font-size:1.2em;margin-right:0.3em;" class="label label-success pull-right">{{ k['first'] | mytor(user['position'] | int )}}</span>
        {% else %}
        <a  href="#" style="font-size:1.2em;margin-right:0.3em;" class="label label-success pull-right editable" data-pk="{{user._id}}" data-name="users/position">{{ user['position'] | emptysign }}</a>
        {% endif %}
        </td>

        <td class="hidden-xs">
            <a class="editable" href="#" 
                data-pk="{{k._id}}"
                data-name="operations/instractor">{{ k['instractor'] | emptysign}}</a><br/>
            <a class="editable" href="#" 
                data-pk="{{k._id}}" 
                data-name="operations/incharge">{{ k['incharge'] | emptysign("חסר") }}</a>
            
<!--             <a class="editable" href="#" 
                data-pk="{{k._id}}" 
                data-name="operations/first">{{ k['first'] | emptysign }}</a> -->
        </td>
        <td width="31%"><button type="button" style="width:8em;" class="btn {{ buttonStatus.buttonClass }} btn-sm btn-arrival pull-right" data-loading-text="טוען..." data-id="{{ k._id  }}"><span class="glyphicon {{ buttonStatus.glyph }} pull-right"></span>&nbsp;{{ buttonStatus.buttonCaption }}</button>
        <td>
            <button type="button" class="btn btn-link modal-list pull-left" id="modal_a_{{ k._id }}" data-toggle="modal" data-target="#modal" href="participants/{{ k._id }}">
                <span id='length_{{ k._id  }}' class="badge badge-primary">{{ k['participate']|length }}</span>
                <i class="fa fa-chevron-left"></i>        
            </a>
        </td>
    </tr>
    {% endfor %}
</table>

{% endblock %}